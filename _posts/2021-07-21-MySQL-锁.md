---
layout: post
title: 锁
catalog: true
tags:
    - MySQL

---

### **redo log和binlog（update时的两阶段提交）**

先redo log prepare 预提交状态，然后写 binlog，然后写 redo log

InnoDB 引擎就是通过 redo log 来支持事务的

### **聚簇索引&非聚簇索引**

| 聚簇索引                                                     | 非聚簇索引                                                   |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 数据存储与索引放到了一块，   索引结构的叶子节点保存了行数据  | 将数据与索引分开存储，   索引结构的叶子节点存放的是数据行的地址 |
| Innodb主键一定是聚簇索引，建议使用int自增作为主键   Myisam没有聚簇索引 |                                                              |
| 范围查询效率高，适合排序                                     |                                                              |

### **！间隙锁怎么解决幻读的**

当前读(select for update)需要配合间隙锁来解决幻读

间隙锁：行锁的一种，

### **间隙锁只会出现在可重复读的事务级别中，且查询条件必须命中索引**

间隙锁遵循左开右闭的原则，如1234，间隙锁会锁住234

### **共享锁，排他锁**

| 读锁(共享锁 | 多个读锁可以共享同一资源   读锁会阻塞写锁 |
| ----------- | ----------------------------------------- |
| 写锁(排他锁 | 写锁会阻塞其他的写锁和读锁                |

### **执行计划**

Id:sql里面有几个select就几个id

Type：优化sql的重要字段

执行效率：all<index<range<ref<eq_ref<const<system

Ref eq_ref命中索引不一定是主键，可能会回表

index：遍历索引树（遍历所有索引）

all：全表扫描

### **ACID是靠什么保证的**

| 原子性 | Undolog保证的，记录了需要回滚的日志信息                      |
| ------ | ------------------------------------------------------------ |
| 一致性 | 由其他三大特性保证                                           |
| 隔离性 | 由mvcc多版本并发控制保证   Mvcc只在读已提交和可重复读下工作  Myisam聚簇索引有两个隐藏列：  每次修改时的事务id、上个版本的位置指针  若当前活动事务id>上个版本的位置指针,则创建readview（即当前活动事务id）  读已提交每次查询前都会重新生成readview  可重复读：之后的读都复用第一次读时生成的readview（效率更高，mysql默认） |
| 持久性 | Redolog+内存binlog，保证宕机时，可以从redolog恢复            |



**读已提交的共享锁是读之后释放还是事务提交之后释放**

