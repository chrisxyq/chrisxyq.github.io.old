---
layout: post
title: 线程死锁示例
catalog: true
tags:
    - Java并发编程

---

## 线程死锁示例

### synchronized演示死锁

```java
public class DeadLockBySynchronized {
    public static Object a= new Object();
    public static Object b= new Object();
    public static void main(String[] args) {
        new Thread(()->{
            synchronized (a){
                System.out.println(Thread.currentThread().getName() + "持有锁a，试图获取锁b");
                try {
                    TimeUnit.SECONDS.sleep(1);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (b){
                    System.out.println(Thread.currentThread().getName() + "获取锁b");
                }
            }
        },"A").start();
        new Thread(()->{
            synchronized (b){
                System.out.println(Thread.currentThread().getName() + "持有锁b，试图获取锁a");
                try {
                    TimeUnit.SECONDS.sleep(1);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (a){
                    System.out.println(Thread.currentThread().getName() + "获取锁a");
                }
            }
        },"B").start();
    }
}
```



### 线程死锁示例1

一人一只筷子

![1596812920164](https://gitee.com/chrisxyq/picgo/raw/master/img/1596812920164.png)

![1596812990231](https://gitee.com/chrisxyq/picgo/raw/master/img/1596812990231.png)

在两个锁之间加上sleep，以增大死锁概率

![1596813075985](https://gitee.com/chrisxyq/picgo/raw/master/img/1596813075985.png)

### 线程死锁示例2

线程任务类的构造函数

![image-20210728111021974](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210728111021974.png)

**线程任务类的run方法：加两个锁**

![image-20210728111044038](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210728111044038.png)

**测试方法：start****方法两个线程**

![image-20210728111105979](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210728111105979.png)

### **死锁排查：windows：jps –l和jstack** 

- 定位故障进程编号：**jps –l**（类似linux ps -ef）（jps.exe在jdk的bin目录下）

- 查看java进程的栈信息：jstack 进程编号（返回是否出现死锁）（jvm自带工具）

![image-20211007104603228](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20211007104603228.png)

![image-20211007104629251](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20211007104629251.png)