---
layout: post
title: Java Web三大组件
catalog: true
tags:
    - Java Web
---
java web三大组件：servlet、filter、listener

## servlet接口

### 如何实现servlet程序

#### 实现servlet接口，重写service方法用于处理请求和响应

servletrequest有个子类叫httpServletRequest

通过使用httpServletRequest的getMethod方法，可以获取前端（form表单）提交的请求类型是get/post

```java
@WebServlet(name = "GetMethodServlet", value = "/GetMethodServlet")
public class GetMethodServlet implements Servlet {
    /**
     * servletrequest有个子类叫httpServletRequest
     * 通过使用httpServletRequest的getMethod方法，可以获取前端（form表单）提交的请求类型是get/post
     * 判断方法是get方法调用还是post调用
     */
    @Override
    public void service(ServletRequest servletRequest, ServletResponse servletResponse) throws ServletException, IOException {
        HttpServletRequest httpServletRequest = (HttpServletRequest) servletRequest;
        String method = httpServletRequest.getMethod();
        servletResponse.setContentType("text/html");

        PrintWriter out = servletResponse.getWriter();
        out.println("<html><body>");
        out.println("<h1>" + method + "</h1>");
        out.println("</body></html>");
    }
```



#### 继承httpServletRequest类、并重写doget和dopost

```java
@WebServlet(name = "GetServletNameServlet", value = "/GetServletNameServlet")
public class GetServletNameServlet extends HttpServlet {
    private String message;

    /**
     * servlet默认是单例，为每个请求分配一条线程，线程不安全
     * 如果在web.xml文件同一个 Servlet 映射了多个 <url-pattern>，也会生成多例
     * 只第一次调用该servlet时候被调用
     * @param servletConfig
     */
    @Override
    public void init(ServletConfig servletConfig) {
        final ServletContext servletContext = servletConfig.getServletContext();
        message = "servletConfig.getServletName():"+servletConfig.getServletName();
    }

    @Override
    public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException {
        response.setContentType("text/html");

        // Hello
        PrintWriter out = response.getWriter();
        out.println("<html><body>");
        out.println("<h1>" + message + "</h1>");
        out.println("</body></html>");
    }
```

index.jsp测试调用

```jsp
<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<!DOCTYPE html>
<html>
<head>
    <title>JSP - Servlet Test Index</title>
</head>
<body>
<h1><%= "Servlet Test Index!" %>
</h1>
<br/>
<a href="GetMethodServlet">GetMethodServlet</a><br>
<a href="GetServletNameServlet">GetServletNameServlet</a><br>
<a href="loginServlet">Login Servlet</a>
</body>
</html>
```



### url地址如何定位到servlet?

1.url地址提供了服务器ip以及端口号、以及服务器工程路径下的具体资源路径

然后根据客户端请求的资源路径在web.xml里面找到映射的servlet名字

然后执行相应的servlet功能代码（url-pattern配置的就是servlet的访问地址，以斜杠打头

![1600133357161](https://gitee.com/chrisxyq/picgo/raw/master/img/1600133357161.png)

2.使用注解

```java
@WebServlet(name = "GetServletNameServlet", value = "/GetServletNameServlet")
```



### servlet生命周期

| 组件           | 作用                                                         | 生命周期                                                     |
| -------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| Servlet        | tomcat负责创建                                               | 1.执行构造器方法<br/>2.执行init初始化方法<br/>===以上，在第一次访问时，创建servlet时候被调用，因此servlet是单例的===<br/>3.执行service方法：每次访问都被调用<br/>4.执行destroy销毁方法：在web工程停止时候，被调用 |
| ServletConfig  | tomcat负责创建<br />获取servlet在web.xml配置的别名<br/>获取servletcontext对象 | 每个servlet程序创建时候，init方法就创建一个对应的servletconfig对象<br /> |
| ServletContext | 获取web.xml配置的上下文参数context-param<br/>context-param属于整个web工程，可以配置监听器、过滤器等 | 一个web工程只有一个servletContext实例<br />servletContext是一个域对象：域指的是存取数据的操作范围为web工程<br />像map一样存取数据<br />web工程启动时创建，web工程销毁时销毁 |

## httpServletRequest&httpServletResponse&请求转发&重定向

### httpServletRequest类获取请求的参数值demo

```jsp
form.jsp
<body>
    <form action="http://localhost:8080/ServletRequestServlet" method="get">
        用户名：<input type="text" name="username" value="${cookie.username.value}"> <br>
        密码：<input type="password" name="password"> <br>
        兴趣爱好：<input type="checkbox" name="hobby" value="cpp">C++
        <input type="checkbox" name="hobby" value="JAVA">JAVA
        <input type="checkbox" name="hobby" value="JS">JS <br>
        <input type="submit" value="登录">
    </form>
</body>
```

```java
@WebServlet(name = "ServletRequestServlet", value = "/ServletRequestServlet")
public class ServletRequestServlet extends HttpServlet {
    /**
     *	httpServletRequest类：tomcat将http请求信息封装进httpServletRequest类
     * httpServletRequest类获取请求的参数值
     */
    @Override
    public void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException {
        final String remoteHost = request.getRemoteHost();
        final String username = request.getParameter("username");
        final String password = request.getParameter("password");
        final String[] hobby = request.getParameterValues("hobby");
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        out.println("<html><body>");
        out.println("<h1>" + "客户端地址:" + remoteHost + "</h1>");
        out.println("<h1>" + "username:" + username + "</h1>");
        out.println("<h1>" + "password:" + password + "</h1>");
        out.println("<h1>" + "hobby:" + hobby.toString() + "</h1>");
        out.println("</body></html>");
    }
```



### httpServletResponse：servlet往客户端回传字符串的方式：

![1603354608201](https://gitee.com/chrisxyq/picgo/raw/master/img/1603354608201.png)

```java
response.setContentType("text/html");
PrintWriter out = response.getWriter();
out.println("<html><body>");
out.println("<h1>" + message + "</h1>");
out.println("</body></html>");
```

### 请求转发&重定向对比

|                          | 请求转发 | 重定向 |
| ------------------------ | -------- | ------ |
| 浏览器地址栏             | 没有变化 | 变化   |
| 几次请求                 | 一次     | 两次   |
| 是否共享request域的数据  | 是       | 否     |
| 是否能访问工程外部的资源 | 不能     | 能     |



### 请求转发：共享request域的数据

![1600141905531](https://gitee.com/chrisxyq/picgo/raw/master/img/1600141905531.png)

```java
@WebServlet(name = "ForwardTestServlet", value = "/ForwardTestServlet")
public class ForwardTestServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        request.setAttribute("Attribute","Attribute");
        RequestDispatcher requestDispatcher = request.getRequestDispatcher("/ForwardServlet");
        requestDispatcher.forward(request,response);
    }
```

```java
@WebServlet(name = "ForwardServlet", value = "/ForwardServlet")
public class ForwardServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        final String attribute = (String) request.getAttribute("Attribute");
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        out.println("<html><body>");
        out.println("<h1>" + "attribute:" + attribute + "</h1>");
        out.println("</body></html>");
    }
```



### 重定向：不共享request域的数据

![1600150699813](https://gitee.com/chrisxyq/picgo/raw/master/img/1600150699813.png)

![1600150801429](https://gitee.com/chrisxyq/picgo/raw/master/img/1600150801429.png)

![1600150835026](https://gitee.com/chrisxyq/picgo/raw/master/img/1600150835026.png)

```JAVA
@WebServlet(name = "RedirectToFormServlet", value = "/RedirectToFormServlet")
public class RedirectToFormServlet extends HttpServlet {
    /**
     * 请求重定向的第二种方案（推荐
     */
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        response.sendRedirect("http://localhost:8080/form.jsp");
    }
```

## 监听器&过滤器实现客户端访问统计

### 监听器

```java
/**
 * @author yuanqixu
 * 监听器：javaweb的三大组件之一
 * ServletContextListener：监听 ServletContext 对象的创建和销毁
 * ServletContext在web工程启动时候创建，web工程停止时候销毁
 */
@WebListener()
public class MyServletContextListenerImpl implements ServletContextListener {
    @Override
    public void contextInitialized(ServletContextEvent sce) {
        System.out.println("===contextInitialized===");
        //1.创建ServletContext
        ServletContext application = sce.getServletContext();
        //2.Map
        HashMap<String, Integer> ipMap = new LinkedHashMap<>();
        //3.把Map保存到ServletContext中
        application.setAttribute("ipMap",ipMap);
    }

```

### 过滤器

```java
@WebFilter("/*")
public class AdminFilter implements Filter {
    @Override
    public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws ServletException, IOException {
        //1.得到ServletContext中的IPMap
        ServletContext application = req.getServletContext();
        //2.获取客户端IP
        String IP = req.getRemoteAddr();
        //3.获得并操作Map
        LinkedHashMap<String, Integer> ipMap = (LinkedHashMap<String, Integer>) application.getAttribute("ipMap");
        if (ipMap.containsKey(IP)) {
            int ipValue = ipMap.get(IP);
            ipMap.put(IP, ++ipValue);
        } else {
            ipMap.put(IP, 1);
        }
        application.setAttribute("ipMap", ipMap);
        //4.放行
        chain.doFilter(req, resp);
    }
```

## cookie&session

### cookie

![1603421233642](https://gitee.com/chrisxyq/picgo/raw/master/img/1603421233642.png)

![1600154731698](https://gitee.com/chrisxyq/picgo/raw/master/img/1600154731698.png)

服务器创建cookie并通知客户端保存cookie

![1600155345567](https://gitee.com/chrisxyq/picgo/raw/master/img/1600155345567.png)

### cookie demo：用户登录记住用户名

```jsp
<body>
    <form action="http://localhost:8080/LoginServlet" method="get">
        用户名：<input type="text" name="username" value="${cookie.username.value}"> <br>
        密码：<input type="password" name="password"> <br>
        <input type="submit" value="登录">
    </form>
</body>
```

```java
@WebServlet(name = "LoginServlet", value = "/LoginServlet")
public class LoginServlet extends HttpServlet {
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        final String username = request.getParameter("username");
        final Cookie cookie = new Cookie("username", username);
        //一周
        cookie.setMaxAge(60 * 60 * 24 * 7);
        response.addCookie(cookie);

        final Cookie[] cookies = request.getCookies();
        response.setContentType("text/html");
        PrintWriter out = response.getWriter();
        out.println("<html><body>");
        for (Cookie cookiee : cookies) {
            out.println("<h1>" + "cookie["+cookiee.getName()+"="+cookiee.getValue()+"]" + "</h1>");
        }
        out.println("</body></html>");
    }
```

点击登录后，返回的是点击登录前浏览器保存的cookie

![image-20210929163836319](https://gitee.com/chrisxyq/picgo/raw/master/image-20210929163836319.png)

![image-20210929163616428](https://gitee.com/chrisxyq/picgo/raw/master/image-20210929163616428.png)

### session会话

![1600158029045](https://gitee.com/chrisxyq/picgo/raw/master/img/1600158029045.png)

#### 创建/获取session会话

![1603431241004](https://gitee.com/chrisxyq/picgo/raw/master/img/1603431241004.png)

#### session域数据的存取

![1603431831841](https://gitee.com/chrisxyq/picgo/raw/master/img/1603431831841.png)

### 浏览器与session关联的技术内幕

![1603434223814](https://gitee.com/chrisxyq/picgo/raw/master/img/1603434223814.png)

jsp作用： 代替servlet回传html页面&从request域中获取信息，并遍历，将数据输出到前端客户端显示