---
layout: post
title: 几种引用&几种OOM
catalog: true
tags:
    - JVM

---

### 几种OOM:ERROR

![image-20210728133525231](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210728133525231.png)

让你写一下堆栈溢出你怎么写？为什么往集合设置那么多元素没有被GC？

#### GC overhead limit：连续多次GC却回收了不到2%内存（一直new大对象导致）

![image-20210728133619103](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210728133619103.png)

#### direct buffer memory：直接内存溢出（NIO程序常出现）

maxDirectMemorySize设置小一点
jvm在堆内存以外、物理内存以内分配对象（好处在于无需复制，效率高）、把物理内存占满了
jvm默认使用物理内存的1/4

#### unable to create new native thread：不能再创建本地线程了（高并发请求服务器时）

linux系统默认一个进程创建线程数不超过1024个

#### metaspace OOM：（默认元空间是21M）

使用CGLib不断生成静态内部类的代理类

![image-20210728133854052](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210728133854052.png)

![image-20210728133906591](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210728133906591.png)

### 强软弱虚引用

#### 强引用：垃圾回收或OOM也不会回收

![image-20210728154118776](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210728154118776.png)

#### 软引用：用于高速缓存、内存不够用就回收

![image-20210728154155366](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210728154155366.png)

![image-20210728154205688](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210728154205688.png)

#### 弱引用：垃圾回收运行则被回收

weakHashMap：即key是弱引用，垃圾回收则map会被清空

threadLocalMap会有内存泄漏

#### 虚引用：无法访问对应的引用对象、且必须和引用队列联合使用

软弱虚引用，引用对象在被回收时，会把引用放到引用队列里面



软弱虚三种引用都是reference的子类

强引用：只要引用关系还存在，垃圾回收器就永远不会回收该对象

软引用：内存不足（内存溢出之前，即回收

弱引用：下一次垃圾回收时，无论内存是否够用，均会回收

虚引用：无法通过虚引用获得对象的实例，虚引用的唯一目的就是使得该对象在被垃圾回收时，收到系统的通知