---
layout: post
title:中间件-nacos配置中心-init
date:  2022-10-10
catalog: true
tags:
    - 配置中心
---

[参考视频](https://www.bilibili.com/video/BV1VJ411X7xX?p=30)

## 环境搭建

### nacos安装

[编译后的源码安装1.1.3(Aug 6th, 2019)]()

解压后运行E:\mysoftware\nacos-server-1.1.3\nacos\bin\startup.cmd

然后访问http://127.0.0.1:8848/nacos

默认账号密码都是nacos

### curl向nacos发布/获取配置

[下载curl](https://curl.se/windows/)

### 外部MySQL支持

MySQL新建nacos_config数据库

![image-20211031105142706](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20211031105142706.png)

在数据库下执行E:\mysoftware\nacos-server-1.1.3\nacos\conf\nacos-mysql.sql文件

修改E:\mysoftware\nacos-server-1.1.3\nacos\conf\application.properties配置文件，新增如下配置

```properties
spring.datasource.platform=mysql
db.num=1
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000
db.user=root
db.password=123456
```

重启nacos服务E:\mysoftware\nacos-server-1.1.3\nacos\bin\startup.cmd

## nacos客户端使用

### java客户端获取nacos配置

```xml
        <dependency>
            <groupId>com.alibaba.nacos</groupId>
            <artifactId>nacos-client</artifactId>
            <version>1.1.3</version>
        </dependency>
```

```java
    public static void main(String[] args) throws NacosException {
        String dataId="nacos-simple-demo.yaml";
        String group="DEFAULT_GROUP";
        String serverAddr="127.0.0.1:8848";
        String nameSpace = "d9c60b7c-9553-4c31-82e6-383509839cfa";
        Properties properties = new Properties();
        properties.put("serverAddr",serverAddr);
        properties.put("namespace", nameSpace);
        ConfigService configService = NacosFactory.createConfigService(properties);
        String config = configService.getConfig(dataId, group, 5000);
        System.out.println(config);
    }
```

| 概念      | 含义                 |
| --------- | -------------------- |
| namespace | 不同的开发环境       |
| group     | 不同的项目           |
| dataid    | 一个工程的主配置文件 |

### java客户端监听服务端的修改

```java
        configService.addListener(dataId, group, new Listener() {
            @Override
            public Executor getExecutor() {
                return null;
            }

            /**
             * 配置有变化时，获取通知
             * @param s
             */
            @Override
            public void receiveConfigInfo(String s) {
                System.out.println(s);
            }
        });
        while (true){
            Thread.sleep(2000);
        }
```

### 修改默认用户名密码

默认用户名密码都是root

密码加密：

```xml
		<dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-core</artifactId>
            <version>5.1.4.RELEASE</version>
        </dependency>
        System.out.println(new BCryptPasswordEncoder().encode("123"));
```

数据库修改

```sql
select * from nacos_config.users
select * from nacos_config.roles 
```

也可关闭登录认证：

修改E:\mysoftware\nacos-server-1.1.3\nacos\conf\application.properties配置文件：spring.security.enabled=false

## 分布式应用配置管理

### 父pom依赖

```xml
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
<!--                <version>2.1.0.RELEASE</version>-->
                <version>2.2.5.RELEASE</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
<!--                <version>Greenwich.RELEASE</version>-->
                <version>Hoxton.SR8</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
<!--                <version>2.1.3.RELEASE</version>-->
                <version>2.3.2.RELEASE</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
```

### 子pom依赖

```xml
    <artifactId>service1</artifactId>
    <dependencies>
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
```

### 子工程配置文件bootstrap.properties

```
server.port=56010
spring.application.name=service1
spring.cloud.nacos.config.server-addr=127.0.0.1:8848
spring.cloud.nacos.config.group=DEFAULT_GROUP
spring.cloud.nacos.config.name=service1.properties
```

```java
    /**
     * 获取nacos实时配置
     http://localhost:56010/configs
     * @return
     */
    @GetMapping(value = "/configs")
    public String getConfigs() {
        System.out.println(config1);
        ConfigurableEnvironment environment = configurableApplicationContext.getEnvironment();
        String property = environment.getProperty("common.name");
        return property;
    }
```

