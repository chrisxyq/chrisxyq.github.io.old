---
layout: post
title: 中间件-ES-init
date:  2022-10-10
catalog: true
tags:
    - ES

---

## ES集成Spring Data实例

### 配置

#### pom

```xml
	<dependencies>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-data-elasticsearch</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter</artifactId>
		</dependency>
		<dependency>
			<groupId>org.springframework.boot</groupId>
			<artifactId>spring-boot-starter-test</artifactId>
			<scope>test</scope>
		</dependency>
```

#### AbstractElasticsearchConfiguration配置类

读取前缀为XX的配置文件，赋值给host和port

```java
@ConfigurationProperties(prefix = "elasticsearch")
@Configuration
@Data
public class ElasticSearchConfig extends AbstractElasticsearchConfiguration {
    private String host;
    private Integer port;
    @Override
    public RestHighLevelClient elasticsearchClient() {
        RestClientBuilder builder = RestClient.builder(new HttpHost(host, port));
        RestHighLevelClient restHighLevelClient = new RestHighLevelClient(builder);
        return restHighLevelClient;
    }
}
```

#### 实体类@Document(indexName = "product")

```java
/**
 * type决定字段是否可以被分词:FieldType.Keyword可以被分词
 * index决定字段是否可以被检索：
 */
@Data
@NoArgsConstructor
@AllArgsConstructor
@ToString
@Document(indexName = "product")
public class Product {
    @Id
    private Long id;
    @Field(type= FieldType.Text)
    private String title;
    @Field(type= FieldType.Keyword)
    private String category;
    @Field(type= FieldType.Double)
    private double price;
    @Field(type= FieldType.Keyword,index = false)
    private String images;
}
```

#### ElasticsearchRepository

```java
@Repository
public interface ProductDao extends ElasticsearchRepository<Product,Long> {
}
```

### 测试

#### 创建和删除索引restTemplate

索引（数据库）、文档（表）、字段（列）

```java
    /**
     * 会自动识别实体类上的注解
     *
     * @Document(indexName = "product")
     * 创建product索引
     * get查看所有索引：http://localhost:9200/_cat/indices?v
     */
    @Test
    void createIndex() {
        System.out.println("创建索引");
    }
```

#### 对文档的CRUD

```java
    /**
     * 像保存对象一样地保存json数据
     * get根据文档id查看索引中的文档数据
     * http://localhost:9200/product/_doc/2
     */
    @Test
    void save() {
        final Product product = new Product();
        product.setId(2L);
        product.setTitle("华为手机");
        product.setCategory("手机");
        product.setPrice(2999);
        product.setImages("http://www.atguigu/hw.jpg");
        productDao.save(product);
    }

    /**
     * 修改
     * get根据文档id查看索引中的文档数据
     * http://localhost:9200/product/_doc/2
     */
    @Test
    void update() {
        final Product product = new Product();
        product.setId(2L);
        product.setTitle("小米2手机");
        product.setCategory("手机");
        product.setPrice(9999);
        product.setImages("http://www.atguigu/xm.jpg");
        productDao.save(product);
    }

    /**
     * 根据id查询
     * get根据文档id查看索引中的文档数据
     * http://localhost:9200/product/_doc/2
     */
    @Test
    void findById() {
        System.out.println(productDao.findById(2L).get());
    }

    /**
     * 查询所有
     * get根据文档id查看索引中的文档数据
     * 查询全量：http://localhost:9200/product/_search
     */
    @Test
    void findAll() {
        final Iterable<Product> products = productDao.findAll();
        for (Product product : products) {
            System.out.println(product);
        }
    }
```

#### 对文档的分页查询：pageRequest

```java
    /**
     * 分页查询
     */
    @Test
    void findByPage() {
        final Sort sort = Sort.by(Sort.Direction.DESC, "id");
        int currentPage = 0;
        int pageSize = 5;
        final PageRequest pageRequest = PageRequest.of(currentPage, pageSize, sort);
        final Page<Product> productPage = productDao.findAll(pageRequest);
        for (Product product : productPage.getContent()) {
            System.out.println(product);
        }
    }
```

#### 对文档的条件查询：termQueryBuilder



## HTTP



## Java Api
