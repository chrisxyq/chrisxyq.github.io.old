---
layout: post
title: 分布式事务
catalog: true
tags:
    - MySQL



---

### 本地事务失效的解决方案

主启动类开启aspectj动态代理

![image-20210801202905499](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210801202905499.png)

![image-20210801202822639](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210801202822639.png)

### 分布式事务

#### 分布式事务举例

如订单包括减库存、保存订单和扣积分三个微服务，服务在不同机器的数据库

微服务架构，分布式事务无法避免，节点之间状态难以同步

#### raft：保证分布式系统的一致性

节点选举：任何一个节点都有三种状态：leader、候选、随从（节点选举

- 选举超时时间：随从变成候选的超时时间150-300ms，在150-300ms的自旋时间内，若没有收到leader的回应，则随从可以变成候选者

- 心跳时间：当上leader之后，leader会向其他节点发送消息（日志复制），发送消息的间隔时间为心跳时间，其余节点每次收到消息都会重置选举超时时间。

- 心跳时间，不能超过选举超时时间，否则就会发生leader选举

- 重试机制：两个候选者票数相同，重新来一轮自旋

- 投票：每个节点只能投一票，先收到谁的投票消息，就投给谁

  

日志复制：向节点写数据：leader和其余节点之间将进行日志复制之后再写数据

raft：即使网络分区错误，也能保证一致性

![image-20210801210812915](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210801210812915.png)

### 分布式事务的解决方案

#### TCC事务补偿

![image-20210801211634500](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210801211634500.png)

#### 可靠消息+最终一致性补偿（mq异步通知解决

![image-20210801211937763](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210801211937763.png)

#### SEATA原理介绍：（TC协调器全局、TM大全局事务、RM微服务小事务

TM大事务一旦开启，各个RM向TC（SEATA提供的事务协调器）汇报事务的成功状态

@GlobalTransaction

![image-20210801212324920](https://gitee.com/chrisxyq/picgo/raw/master/https://gitee.com/chrisxyq/image-20210801212324920.png)

注意：每个微服务都需要建立回滚日志表undo_log，使得成功的微服务事务可以自动回滚（无需手动编写回滚代码

#### SEATA使用示例

290集

